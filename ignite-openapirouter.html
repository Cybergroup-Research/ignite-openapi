<script type="text/javascript">
    RED.nodes.registerType('ignite-openapirouter', {
        category: 'network',
        color: '#b197ff',
        defaults: {
            name: { value: "" },
            docurl: { value: "" },
            hidddenendpointsdata : {value: ""},
            outputs: { value: 1}
        },
        inputs: 0,
        outputs: 1,
        outputLabels : function (index) { 
            if(this.hidddenendpointsdata){
                try{
                    var data = JSON.parse(this.hidddenendpointsdata);
                    return `${data[index].method} : ${data[index].url}`;
                }catch(error){
                    console.log(error);
                    this.hidddenendpointsdata = ""
                }
            }
        },
        icon: 'font-awesome/fa-tasks',
        label: function () {
            return this.name || "api router";
        },
        oneditprepare : function () {
            if(this.hidddenendpointsdata){
                try{
                    prepareEndpoints(JSON.parse(this.hidddenendpointsdata));
                }catch(error){
                    console.log(error);
                    this.hidddenendpointsdata = ""
                }
            }
        },
        oneditsave : function () {
            //clearing data from input field and restoring data to add manually added fields
            $("#node-input-hidddenendpointsdata").val("");

            //read data from table
            $('#node-input-endpoints-container tr').each(function(){
                let row = $(this);
                var method_field  = row.find('select')
                var url_field  = row.find('input')
                if (method_field[0] && url_field[0]){
                    let method = method_field[0].value;
                    let url = url_field[0].value;
                    let endpoint = {
                        "method" : method,
                        "url": url
                    }
                    saveDataToInputField(endpoint);
                }
            });

            //setting the output points
            let endpoints_data = $("#node-input-hidddenendpointsdata").val();
            if(endpoints_data.length > 0){
                $("#node-input-outputs").val((JSON.parse(endpoints_data)).length);
            }
        }
    });

    async function readOpenApiDoc(){
        var openApiUrl = $('#node-input-docurl').val();
        if (openApiUrl === undefined || openApiUrl === '') {
                $('#node-input-readdoc-msg').html(`Please provide a valid Open Api Url.`);
                $('#node-input-readdoc-msg').show();
            return
        }else{
            try{
                var response = await fetch(openApiUrl);
                var data = await response.json();
                if(data){
                    $('#node-input-readdoc-msg').html(``);
                    $('#node-input-readdoc-msg').hide();
                    var basePath = data.basePath;
                    var endpoints = Object.keys(data.paths);

                    //transform data for populating the endpoints table
                    endpoints_details = [];
                    for(let i in endpoints){
                        let methods = Object.keys(data.paths[endpoints[i]])
                        for(let j in methods){
                            item = {
                                "method": methods[j],
                                "url":  basePath ? `${basePath}${endpoints[i]}` : endpoints[i]
                            }
                            endpoints_details.push(item);
                        }
                    }

                    //call the function to prepare endpoints > then populate the table
                    prepareEndpoints(endpoints_details);
                    return ;
                }else{
                    $('#node-input-readdoc-msg').html(`No Data Recieved from Url.`);
                    $('#node-input-readdoc-msg').show();
                }
            }catch(error){
                console.log(error);
                $('#node-input-readdoc-msg').html(`Error while processing data.`);
                $('#node-input-readdoc-msg').show();
                return
            }
        }
    }
    
    //clears the table and values stored in hidden field
    function clearEndpointsData(){
        $("#node-input-endpoints-container").empty()
        $("#node-input-hidddenendpointsdata").val("");
        $("#node-input-outputs").val(1);
    }

    function prepareEndpoints(data){
        clearEndpointsData();
        for (let i in data){
            let method = data[i].method.toUpperCase();
            let url = data[i].url;

            //Adding fornward slaces to path if not present
            if(url.slice(0,1) !== "/"){
                url = `/${url}`
            }

            //converting swagger url ro express compatible url
            if(url.includes('{') && url.includes('{')){
                //changing opening brace { with :
                url = url.replaceAll('{',':');
                //removing ending brace}
                url = url.replaceAll('}','');
            }
            
            pushToTable(method, url);
        }
    }

    function pushToTable(method="GET", url=""){
        let unique_id = Math.floor(1000 + Math.random() * 9000);

        //inserting row into the table
        $(`<tr style="width=100%;height:35px;margin-top:5px;" id="node-input-openapi-endpoints-row-${unique_id}">
            <td>
                <select name="method" id="node-input-openapi-methods-${method}-${unique_id}" style="width:100%;">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="PATCH">PATCH</option>
                    <option value="DELETE">DELETE</option>
                </select>
            </td>
            <td>
                <input type="text" style="width:100%;" placeholder="/url" value="${url}">
            </td>
        </tr>`).appendTo("#node-input-endpoints-container");
        $(`#node-input-openapi-methods-${method}-${unique_id}`).val(method);
        
        //saving data to preserve values
        let endpoint = {
            "method": method,
            "url": url
        }
        saveDataToInputField(endpoint);
    }

    function saveDataToInputField(endpoint){
        try{
            let endpoints = $("#node-input-hidddenendpointsdata").val();
            if(endpoints.length !== 0){
                endpoints = JSON.parse(endpoints);
            }else {
                endpoints = [];
            }
            endpoints.push(endpoint);
            $("#node-input-hidddenendpointsdata").val(JSON.stringify(endpoints));
        }catch(e){
            console.log("error saving data to input field", e)
        }
    }
</script>

<script type="text/html" data-template-name="ignite-openapirouter">
    <div class="form-row">
        <label for="node-input-name">Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <label for="node-input-docurl">URL</label>
        <input type="text" id="node-input-docurl" value='' placeholder="https://your-appname.com/openapi/schema">
    </div>
    <div class="form-row">
        <label for="node-input-readdoc">Action</label>
        <button id="node-input-readdoc" onClick="readOpenApiDoc()" >Load Specification</button>
    </div>
    <div class="form-row">
        <h4 id="node-input-readdoc-msg" style="display:none;color:maroon;text-align:center;" ></h4>
    </div>
    <div style="width:100%;overflow-y:auto;height:250px;border:2px solid #f3f3f3">
        <div class="form-row" id="node-input-endpoints-container-row">
            <table style="width:100%" id="node-input-endpoints-container">
                <thead>
                    <tr style="width=100%;height:35px;background-color:#f3f3f3">
                        <th style="width:25%">Method</th>
                        <th style="width:75%">Url</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <div class="form-row" style="width:100%; margin-top:10px;display:flex;flex-direction:row;justify-content:space-between">
        <button onClick="pushToTable()" style="width:49%">New Endpoint</button>
        <button onClick="clearEndpointsData()" style="width:49%;">Clear All</button>
    </div>
    <input type="hidden" id="node-input-hidddenendpointsdata" value=''>
    <input type="hidden" id="node-input-outputs"/>
</script>

<script type="text/html" data-help-name="ignite-openapirouter">
    <p></p>
</script>